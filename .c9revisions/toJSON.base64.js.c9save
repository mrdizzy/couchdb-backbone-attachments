{"ts":1361398456545,"silentsave":true,"restoring":false,"patch":[[{"diffs":[[1,"toJSON: function(callback) {\r\n        var json = _.clone(this.attributes);\r\n        json._attachments = {};\r\n        var attachments = this.get(\"_attachments\").filter(function(attachment) {\r\n            return attachment.get(\"binary\");\r\n        });\r\n        if (attachments.length === 0) {\r\n            callback(json) \r\n            return;\r\n        }\r\n        // We need to use a counter as loading of the files is asynchronous\r\n        // and we do not want to return until they are all loaded\r\n        var counter = 0;\r\n        _.each(attachments, function(attachment) {\r\n\r\n            var fReader = new FileReader();\r\n            fReader.onload = function(event) {\r\n                counter++;\r\n                var data = event.target.result.split(\",\")[1];\r\n                json._attachments[attachment.id] = {\r\n                    content_type: attachment.get(\"content_type\"),\r\n                    data: data\r\n                }\r\n                if (counter == attachments.length) {\r\n                   console.log(json)\r\n                    callback(json);\r\n                }\r\n            }\r\n            fReader.readAsDataURL(attachment.get(\"binary\"))\r\n        })\r\n    },"]],"start1":0,"start2":0,"length1":0,"length2":1174}]],"length":1174}
